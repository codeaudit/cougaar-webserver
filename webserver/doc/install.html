<html>
<head>
<title>Servlet server install guide</title>
</head>
<body bgcolor="white">
<p>
<center><h1>Servlet server install guide</h1></center>
<p>
<ol>
<li>
Download the latest build from 
<a href="http://www.cougaar.org"
>http://www.cougaar.org</a>
and install as usual.
</li><p>
 
<li>
By default the servlet server is enabled to run HTTP on port 8800.
<p>
For new users it's recommended to:
<ol>
  <li>
  <i>First</i> try the default server configuration with a simple 
  society (e.g. "minitestconfig").  This will quickly verify 
  that Cougaar has been installed correctly and that the 
  basic HTTP support works.
  </li>
  <li>
  <i>Later</i> attempt to (optionally) configure the server for 
  additional security, HTTPS, client-authentication, etc.
  </li>
</ol>
<p>
So, for your first test, you should skip ahead to the 
<a href="#ini">".ini" step</a>.
</li><p>

<li>
To disable the server, add this Java property:
<pre>
    -Dorg.cougaar.core.servlet.enable=false
</pre>
</li><p>

<li>
There are several other system properties that can be used to
configure the server.  The defaults are usually fine.
<p>
Here are the additional (optional) properties that you can set:
<pre>
 -Dorg.cougaar.lib.web.scanRange=INT          (defaults to 100)
 -Dorg.cougaar.lib.web.http.port=INT          (defaults to 8800, -1 disables HTTP)
 -Dorg.cougaar.lib.web.https.port=INT         (defaults to -1, -1 disables HTTPS, the typical value is 8400)
 -Dorg.cougaar.lib.web.https.clientAuth=BOOL  (defaults to false) <a name="clientAuth"/>
</pre><p>
<p>
The "scanRange" sets a limit for the server's search for an open port.
First the given HTTP/HTTPS ports are tried, then they are both 
incremented by one, tried again, etc.  If more than "scanRange" ports 
are already in use then the server throws a BindException and quits.  
Setting the "scanRange" to 1 will force exact port addresses.
</li><p>

<li>
Optional HTTPS support:
<p>
<ol>
<li>
To enable HTTPS, set the Java property to specify the HTTPS port:
<pre>
  -Dorg.cougaar.web.https.port=8400
</pre>
Port "8400" is the typical Cougaar HTTPS port.
</li><p>
<li>
Create a keystore to hold the server's private RSA certificate.  There are 
many 3rd-party utilities that can be used to create a server certificate,
but here we'll use the Sun "keytool" <a name="keytool"> that is included 
with the JDK.
<p>
Here's a link to 
<a href=
"http://java.sun.com/products/jdk/1.2/docs/tooldocs/solaris/keytool.html"
>additional keytool documentation</a>.
<p>
The keystore file must be placed in the $COUGAAR_INSTALL_PATH or a 
subpath -- here we'll name the file 
"$COUGAAR_INSTALL_PATH/bin/certs". <a name="keystore">
Note that the typical JSSE/JDK's "${user.home}/.keystore" and 
"${java.home}/jre/lib/security/.keystore" are <b>NOT</b> assumed!
<p>
The certificate alias must be "tomcat" to work with Cougaar's Tomcat 4.0.3
servlet Server implementation, and must be an RSA certificate.  
Additionally the certificate's "name" must be the host's name, such as
"foo.com" <a name="hostname">.  Here's
the full keytool command:
<pre>
    % cd $COUGAAR_INSTALL_PATH/bin
    % keytool -genkey -keyalg rsa -alias tomcat -keystore certs -dname "o=cougaar, cn=<b><i>&lt;hostname&gt;</i></b>" -keypass <b><i>&lt;password&gt;</i></b> -storepass <b><i>&lt;password&gt;</i></b>
</pre><p>
where, for example:
<pre>
   <b><i>&lt;hostname&gt;</i></b> == foo.com
   <b><i>&lt;password&gt;</i></b> == changeit <a name="password">
</pre> <p>
The above keystore will allow server-only SSL authentication, which will
provide an encrypted channel for client-server communications.  See below
for two-way <a href="#instClientAuth">client-server authentication</a>.
<p>
Ideally all machines in a multi-host society would have different
keystores and certificates.  For testing one can create a single
keystore and copy it amongst the machines, then ignore the
"hostname doesn't match certificate's hostname" warnings when
using HTTPS.
</li><p>

<li>
The keystore filename and password are kept within Cougaar's 
"org.cougaar.util.Parameters" table under these two names:
<p>
<ol>
  <li>"org.cougaar.web.keystore" for the keystore file name</li>
  <li>"org.cougaar.web.keypass"  for the password to the keystore</li>
</ol>
<p>
In this example we want the values to be:
<pre>
  org.cougaar.web.keystore=<a href="#keystore">bin/certs</a>
  org.cougaar.web.keypass=<a href="#password">changeit</a>
</pre>
Edit the "cougaar.rc" file to add the above two lines.  The 
"cougaar.rc" is typically kept as:
<pre>
  $COUGAAR_INSTALL_PATH/configs/common/cougaar.rc
</pre><p>
See the javadocs for "Parameters" for additional options, such
as passing these values as "-D" system properties.
</li><p>

<li>
<a name="instClientAuth">
To additionally enable (optional) HTTPS client authentication:
<p>
First, enable the <a href="#clientAuth">"clientAuth" system property</a>.
<p>
The client's public signer's certificate ("certificate-authority cert")
must be imported into the server's <a href="#keystore">"bin/certs"</a> 
keystore file.  This is a Tomcat 4.0.3 requirement.
<p>
Unfortunately <a href="#keytool">Keytool</a> can not be used to create a 
client certificate.  There are other 3rd-party tools and companies
that will generate a client certificate and manage the 
certificate-authority work, such as 
<a href="http://www.openssl.org">OpenSSL</a>.
<p>
With client authentication enabled the server will only accept HTTPS
requests from trusted clients.  A trusted client is a client that 
provides a client-certificate (via SSL) that has been signed by a public 
certificate-authorities certificate that's already in the server's 
keystore.  For example, if the server's keystore includes the public
Netscape certificate, then all clients that present certificates that are 
signed by Netscape will be accepted.  The client (browser, application, 
whatever) must be separately configured to pass the client certificate 
as part of the HTTPS request.
<p>
A special-case for client authentication is to let the client use the
server's certificate, in which case the server's keystore only needs
to contain the server's certificate.
</li><p>

<li>
A user-developed servlet can check for 
<a href="http://java.sun.com/products/servlet/2.2/javadoc/javax/servlet/ServletRequest.html#isSecure()"
>"HttpServletRequest.isSecure()"</a> to see if a particular request
used HTTPS security.
</li><p>
</ol>
</li><p>

<li>
Optional username/password authentication:
<p>
As an example of username / password authentication, the Tomcat 4.0.3 
server implementation is configured to prompt for a login for
all requests with paths that end in ".secure". <a name="secure">  
This is defined in:
<pre>
   webtomcat/data/webapps/ROOT/WEB-INF/web.xml  <a name="web.xml">
</pre><br>
The pattern can be modified to another path or multiple 
"&lt;url-pattern&gt;" entries for testing.
<p>
The usernames and passwords are stored in:
<pre>
   webtomcat/data/conf/tomcat-users.xml
</pre><br>
By default (for testing <b><i>only</i></b>) there is one user:
<pre>
   username: test    password: test
</pre><br>
<p>
To test the login support you should either modify the 
<a href="#web.xml">"web.xml"</a> and/or define a servlet with a
<a href="#secure">"*.secure"</a> path within your 
<a href="#ini">.ini</a> files (e.g. "/tasks.secure").
</li><p>

<li>
To optionally disable the server printing of stack-traces to clients, 
such as when a servlet throws an exception, modify:
<pre>
  webtomcat/data/conf/server.xml
</pre><br>
to have:
<pre> 
  &lt;ContextManager ... showDebugInfo="false" &gt;
</pre><br>
Note that this will make servlet-debugging more difficult, since
users can no longer cut-&amp;-paste exceptions and report them
back to the developers.  However, it can be seen as a minor 
security enhancement, since it hides the code details.
</li><p>

<li>
<a name="ini">
By itself the servlet server will only load the basic "/agents" and
"/list" servlets that are described in the 
<a href=
"../../doc/details/Servlet.html"
>doc/details/Servlet.html</a>
guide.
<p>
User-developed servlets are loaded like plugins; they are listed in
either the agent ".ini" files or in the CSMART database.  Most of the 
Cougaar sample societies (minitestconfig, small-135, tiny-1ad, etc) 
have already been modified to load several servlets by default.
<p>
For this simple test you should verify that at least one agent's 
".ini" includes this line:
<pre>
  plugin = org.cougaar.core.servlet.SimpleServletComponent(org.cougaar.planning.servlet.PlanViewServlet, /tasks)
</pre><br>
This will load the "/tasks" servlet, which generates an HTML view of the 
agent blackboard.
<p>
The 
<a href=
"../../doc/details/Servlet.html"
>doc/details/Servlet.html</a>
guide includes notes on:
<ul>
  <li>how to develop servlets</li>
  <li>a table of Cougaar servlets ("/tasks", etc)</li>
  <li>additional example servlets</li>
</ul>
</li><p>

<li>
Start the node(s) as usual.  You should see this message:
<pre>
  Starting HTTP  server on port: 8800
</pre>
<p>
If you are also running HTTPS you should additionally see this 
message:
<pre>
  Starting HTTPS server on port: 8400
</pre>
The HTTPS startup may take several seconds (~10 seconds) to initialize 
the SSL random number generator for secure encryption.
<p>
If the Server was unable to start you should see a specific error 
message, and the user-developed servlets may throw
"Unable to obtain servlet service" stack traces.
<p>
If more than one node is running on a machine then each node will
use different ports (8801, 8802, etc).  The base "8800" and "8400"
ports can usually be assumed by browsers and clients, since the 
servlet server will automatically redirect requests to the 
appropriate host:port.
</li><p>

<li>
Internet Exporer users should disable the "friendly HTML error page"
option:
<pre>
  tools-&gt;Internet Options-&gt;Advanced-&gt;Show Friendly HTTP error messages == UNCHECKED
</pre><br>
<p>
This will allow your browser to display useful "path-not-found"
and "unknown-agent" error pages.
</li><p>

<li>
In a web browser load this page:
<pre>
  http://foo.com:8800
</pre><br>
to generate the default "welcome" page.  Click on the
"list local agents" link, then click on any agent's link.
This will generate the "/list" listing of servlets that
are running in that agent.  Click on the "/tasks" entry
to access the "/tasks" servlet, which will generate an HTML 
page.
<p>
To try the HTTPS support, do exactly the same steps as above,
but start with:
<pre>
  https://foo.com:8400
</pre><br>
Your browser will be prompted to accept the server's 
certificate.  When using HTTPS, your browser may warn you
if you used "http://localhost:8400", instead of the certificate
specifies the full host name ("foo.com").
</li><p>

</ol>

</body>
</html>
